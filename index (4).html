<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Sean's Daily Ops</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Daily Ops">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0a">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0a0a; --surface:#111; --surface2:#181818;
  --border:#222; --border2:#2e2e2e; --text:#f0f0ee;
  --muted:#555; --muted2:#888; --accent:#e8ff47;
  --accent-dim:rgba(232,255,71,0.12); --green:#4ade80;
  --green-dim:rgba(74,222,128,0.1); --red:#f87171;
  --water:#38bdf8; --water-dim:rgba(56,189,248,0.12);
  --purple:#c084fc; --orange:#fb923c;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;min-height:100vh;padding-bottom:env(safe-area-inset-bottom);}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:100;background:rgba(10,10,10,0.94);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);padding:14px 20px;padding-top:calc(14px + env(safe-area-inset-top));display:flex;align-items:center;justify-content:space-between;gap:12px;}
.app-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:0.05em;color:var(--accent);line-height:1;}
.today-badge{font-family:'Courier Prime',monospace;font-size:11px;color:var(--muted2);border:1px solid var(--border2);padding:4px 10px;border-radius:20px;}

/* DAY PILLS â€” horizontal scroll */
.day-selector-wrap{padding:18px 20px 0;}
.day-selector-label{font-family:'Courier Prime',monospace;font-size:10px;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.day-pills{display:flex;gap:7px;overflow-x:auto;padding-bottom:4px;margin-bottom:16px;scrollbar-width:none;}
.day-pills::-webkit-scrollbar{display:none;}
.day-pill{position:relative;cursor:pointer;border-radius:10px;border:1.5px solid var(--border2);padding:9px 13px;background:var(--surface);transition:all 0.2s;min-width:68px;flex-shrink:0;text-align:center;user-select:none;}
.day-pill:hover{border-color:#444;background:var(--surface2);}
.day-pill.active{border-color:var(--accent);background:var(--accent-dim);}
.day-pill.active .pill-name{color:var(--accent);}
.day-pill.today-pill .pill-name::after{content:'Â·';color:var(--accent);margin-left:2px;}
.pill-name{font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:0.05em;color:var(--text);line-height:1;margin-bottom:2px;}
.pill-sub{font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);}
.pill-date{font-family:'Courier Prime',monospace;font-size:9px;color:var(--muted);margin-bottom:2px;}
.pill-done-dot{position:absolute;top:5px;right:5px;width:7px;height:7px;border-radius:50%;background:var(--green);display:none;}
.day-pill.has-history .pill-done-dot{display:block;}

/* SHIFT BANNER */
.shift-banner{margin:0 20px 14px;background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:13px 16px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
.shift-banner-left{flex:1;min-width:0;}
.shift-banner-label{font-family:'Courier Prime',monospace;font-size:10px;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.shift-banner-time{font-family:'Bebas Neue',sans-serif;font-size:21px;color:var(--text);letter-spacing:0.05em;}
.shift-banner-time span{color:var(--accent);}
.no-shift-set{color:var(--muted2);font-size:13px;font-family:'Outfit',sans-serif;font-weight:400;}
.event-badge{display:inline-flex;align-items:center;gap:5px;margin-top:5px;margin-right:4px;background:rgba(192,132,252,0.12);border:1px solid rgba(192,132,252,0.3);border-radius:20px;padding:3px 10px;font-size:11px;color:var(--purple);font-weight:500;}
.edit-shift-btn{background:var(--surface2);border:1px solid var(--border2);color:var(--muted2);font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;padding:7px 14px;border-radius:7px;cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0;}
.edit-shift-btn:hover{border-color:var(--accent);color:var(--accent);}

/* PROGRESS */
.progress-wrap{padding:0 20px 14px;}
.progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.progress-label{font-family:'Courier Prime',monospace;font-size:10px;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);}
.progress-count{font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--accent);letter-spacing:0.05em;}
.progress-track{height:4px;background:var(--border2);border-radius:2px;overflow:hidden;}
.progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.5s cubic-bezier(0.34,1.56,0.64,1);width:0%;}

/* WATER TRACKER */
.water-card{margin:0 20px 14px;background:var(--surface);border:1px solid rgba(56,189,248,0.25);border-radius:10px;padding:14px 16px;}
.water-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.water-title{font-family:'Courier Prime',monospace;font-size:10px;letter-spacing:0.2em;text-transform:uppercase;color:var(--water);}
.water-right{display:flex;align-items:center;gap:10px;}
.water-count-label{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--water);}
.water-oz{font-family:'Courier Prime',monospace;font-size:10px;color:var(--muted);margin-top:2px;}
.water-bottles{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.bottle{display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;user-select:none;transition:all 0.2s;padding:6px 8px;border-radius:8px;border:1.5px solid var(--border2);background:var(--surface2);min-width:52px;}
.bottle:hover{border-color:var(--water);transform:translateY(-2px);}
.bottle.filled{border-color:var(--water);background:var(--water-dim);}
.bottle-icon{font-size:22px;filter:grayscale(1) opacity(0.35);transition:filter 0.2s;}
.bottle.filled .bottle-icon{filter:none;}
.bottle-label{font-family:'Courier Prime',monospace;font-size:9px;color:var(--muted);letter-spacing:0.05em;}
.bottle.filled .bottle-label{color:var(--water);}
.water-note{font-size:11px;color:var(--muted);}
.water-note span{color:var(--water);font-weight:600;}
.water-progress-wrap{margin-bottom:8px;}
.water-progress-track{height:3px;background:var(--border2);border-radius:2px;overflow:hidden;}
.water-progress-fill{height:100%;background:var(--water);border-radius:2px;transition:width 0.4s ease;}

/* CONTENT */
.content{padding:0 20px 60px;display:grid;grid-template-columns:1fr 296px;gap:16px;align-items:start;}

/* TASK CARDS */
.task-list{display:flex;flex-direction:column;gap:7px;}
.task-card{background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:13px 15px;display:flex;align-items:flex-start;gap:12px;cursor:pointer;transition:all 0.2s;animation:slideIn 0.3s ease both;position:relative;overflow:hidden;}
.task-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--card-color,var(--border2));opacity:0;transition:opacity 0.2s;}
.task-card:hover{border-color:#333;background:var(--surface2);}
.task-card:hover::before,.task-card.done::before{opacity:1;}
.task-card.done{opacity:0.45;}
.task-card.done .task-label{text-decoration:line-through;color:var(--muted2);}
.task-card.done::before{background:var(--green)!important;}
.task-card.event-task{border-color:rgba(192,132,252,0.3);}
.task-card.anchor-task{border-color:rgba(232,255,71,0.25);}
.task-check{width:21px;height:21px;border-radius:6px;border:1.5px solid var(--border2);flex-shrink:0;display:flex;align-items:center;justify-content:center;margin-top:1px;transition:all 0.2s;font-size:11px;}
.task-card.done .task-check{background:var(--green);border-color:var(--green);color:#000;}
.task-body{flex:1;min-width:0;}
.task-top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:2px;}
.task-time{font-family:'Courier Prime',monospace;font-size:10px;letter-spacing:0.1em;color:var(--muted);text-transform:uppercase;}
.task-duration{font-family:'Courier Prime',monospace;font-size:10px;color:var(--muted);background:var(--surface2);padding:1px 7px;border-radius:10px;white-space:nowrap;border:1px solid var(--border);}
.task-label{font-size:13px;font-weight:600;color:var(--text);margin-bottom:2px;}
.task-note{font-size:11px;color:var(--muted2);font-weight:300;}
.task-tag{font-size:10px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;padding:2px 7px;border-radius:20px;margin-top:5px;display:inline-block;}
.anchor-badge{font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;padding:1px 6px;border-radius:10px;background:var(--accent-dim);color:var(--accent);margin-left:6px;vertical-align:middle;}
@keyframes slideIn{from{opacity:0;transform:translateX(-8px);}to{opacity:1;transform:translateX(0);}}
.task-card:nth-child(1){animation-delay:.02s}.task-card:nth-child(2){animation-delay:.05s}.task-card:nth-child(3){animation-delay:.08s}.task-card:nth-child(4){animation-delay:.11s}.task-card:nth-child(5){animation-delay:.14s}.task-card:nth-child(6){animation-delay:.17s}.task-card:nth-child(7){animation-delay:.20s}.task-card:nth-child(8){animation-delay:.23s}.task-card:nth-child(9){animation-delay:.26s}.task-card:nth-child(10){animation-delay:.29s}

/* SIDEBAR */
.sidebar{display:flex;flex-direction:column;gap:13px;}
.sidebar-card{background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:16px 18px;}
.sidebar-card h3{font-family:'Courier Prime',monospace;font-size:10px;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
.streak-display{display:flex;align-items:baseline;gap:5px;margin-bottom:5px;}
.streak-num{font-family:'Bebas Neue',sans-serif;font-size:48px;color:var(--accent);line-height:1;}
.streak-unit{font-size:13px;color:var(--muted2);}
.streak-sub{font-size:11px;color:var(--muted);line-height:1.5;}
.week-dots{display:flex;gap:5px;margin-top:10px;}
.w-dot{flex:1;aspect-ratio:1;border-radius:4px;background:var(--border);display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:10px;color:var(--muted);}
.w-dot.partial{background:rgba(232,255,71,0.2);color:var(--accent);}
.w-dot.full{background:var(--accent);color:#000;}
.w-dot.today-dot{outline:2px solid var(--accent);outline-offset:1px;}
.heatmap{display:flex;flex-direction:column;gap:7px;}
.heatmap-row{display:flex;align-items:center;gap:7px;}
.heatmap-day-label{font-family:'Bebas Neue',sans-serif;font-size:12px;color:var(--muted2);width:28px;flex-shrink:0;}
.heatmap-bar-wrap{flex:1;height:18px;background:var(--border);border-radius:4px;overflow:hidden;}
.heatmap-bar{height:100%;border-radius:4px;transition:width 0.6s cubic-bezier(0.34,1.2,0.64,1);}
.heatmap-pct{font-family:'Courier Prime',monospace;font-size:10px;color:var(--muted);width:28px;text-align:right;flex-shrink:0;}
.log-list{display:flex;flex-direction:column;gap:5px;max-height:180px;overflow-y:auto;}
.log-list::-webkit-scrollbar{width:3px;}.log-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.log-item{display:flex;justify-content:space-between;align-items:center;gap:7px;font-size:11px;padding:6px 9px;background:var(--surface2);border-radius:6px;}
.log-item-left{display:flex;align-items:center;gap:7px;}
.log-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.log-text{color:var(--text);font-weight:500;}
.log-meta{color:var(--muted);font-family:'Courier Prime',monospace;font-size:10px;}
.log-pct{font-family:'Courier Prime',monospace;font-size:10px;padding:2px 6px;border-radius:10px;background:var(--border);color:var(--muted2);flex-shrink:0;}
.log-pct.good{background:var(--green-dim);color:var(--green);}
.log-pct.great{background:var(--accent-dim);color:var(--accent);}
.empty-state{text-align:center;padding:28px 12px;color:var(--muted);font-size:12px;line-height:1.7;font-family:'Courier Prime',monospace;}
.empty-state .big{font-size:28px;margin-bottom:8px;}
.reset-btn{display:block;width:100%;margin-top:10px;padding:8px;background:transparent;border:1px solid var(--border2);border-radius:7px;color:var(--muted);font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;transition:all 0.2s;}
.reset-btn:hover{border-color:var(--red);color:var(--red);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.87);backdrop-filter:blur(8px);z-index:200;display:flex;align-items:flex-start;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity 0.25s;overflow-y:auto;}
.modal-overlay.show{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:16px;padding:26px 22px;width:100%;max-width:420px;transform:translateY(20px);transition:transform 0.25s;margin:auto;}
.modal-overlay.show .modal{transform:translateY(0);}
.modal h2{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:0.05em;color:var(--accent);margin-bottom:5px;}
.modal-sub{font-size:12px;color:var(--muted2);margin-bottom:22px;line-height:1.55;}
.modal-field{margin-bottom:16px;}
.modal-field label{display:block;font-family:'Courier Prime',monospace;font-size:10px;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.time-select{width:100%;background:var(--surface2);border:1.5px solid var(--border2);color:var(--text);font-family:'Outfit',sans-serif;font-size:15px;font-weight:500;padding:10px 12px;border-radius:8px;cursor:pointer;appearance:none;transition:border-color 0.2s;}
.time-select:focus{outline:none;border-color:var(--accent);}
.text-input{width:100%;background:var(--surface2);border:1.5px solid var(--border2);color:var(--text);font-family:'Outfit',sans-serif;font-size:14px;font-weight:400;padding:10px 12px;border-radius:8px;transition:border-color 0.2s;}
.text-input:focus{outline:none;border-color:var(--purple);}
.text-input::placeholder{color:var(--muted);}
.event-time-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.day-off-row{display:flex;align-items:center;gap:10px;margin-top:4px;}
.divider{border:none;border-top:1px solid var(--border2);margin:18px 0;}
.event-section-title{font-family:'Courier Prime',monospace;font-size:10px;letter-spacing:0.2em;text-transform:uppercase;color:var(--purple);margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.event-section-title::after{content:'';flex:1;height:1px;background:rgba(192,132,252,0.2);}
.events-list{display:flex;flex-direction:column;gap:6px;margin-bottom:12px;max-height:160px;overflow-y:auto;}
.event-item{display:flex;align-items:center;justify-content:space-between;background:rgba(192,132,252,0.08);border:1px solid rgba(192,132,252,0.2);border-radius:7px;padding:8px 10px;gap:8px;}
.event-item-text{font-size:12px;color:var(--text);font-weight:500;flex:1;}
.event-item-time{font-family:'Courier Prime',monospace;font-size:10px;color:var(--purple);}
.event-delete{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:0 2px;line-height:1;transition:color 0.15s;}
.event-delete:hover{color:var(--red);}
.add-event-btn{width:100%;padding:9px;background:rgba(192,132,252,0.1);border:1px dashed rgba(192,132,252,0.3);border-radius:8px;color:var(--purple);font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;}
.add-event-btn:hover{background:rgba(192,132,252,0.18);border-style:solid;}
.modal-btn{width:100%;padding:13px;background:var(--accent);border:none;border-radius:9px;color:#000;font-family:'Outfit',sans-serif;font-size:14px;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;cursor:pointer;margin-top:20px;transition:opacity 0.2s;}
.modal-btn:hover{opacity:0.9;}
.modal-cancel{display:block;text-align:center;margin-top:12px;color:var(--muted);font-size:12px;cursor:pointer;}
.modal-cancel:hover{color:var(--text);}

/* WORKOUT TYPE TOGGLE */
.workout-toggle{display:flex;gap:6px;}
.workout-opt{flex:1;padding:9px 6px;text-align:center;border-radius:7px;border:1.5px solid var(--border2);background:var(--surface2);color:var(--muted2);font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.15s;}
.workout-opt.selected{border-color:var(--green);background:var(--green-dim);color:var(--green);}

/* SCHEDULE INFO CARD */
.schedule-info{background:rgba(232,255,71,0.05);border:1px solid rgba(232,255,71,0.15);border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:11px;color:var(--muted2);line-height:1.6;}
.schedule-info strong{color:var(--accent);}

/* TOAST */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--surface2);border:1px solid var(--border2);color:var(--text);padding:11px 18px;border-radius:10px;font-size:13px;font-weight:500;z-index:999;transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);pointer-events:none;white-space:nowrap;max-width:90vw;}
.toast.show{transform:translateX(-50%) translateY(0);}

@media(max-width:700px){.content{grid-template-columns:1fr;}.sidebar{display:grid;grid-template-columns:1fr 1fr;}}
@media(max-width:480px){.sidebar{grid-template-columns:1fr;}.water-bottles{gap:5px;}.bottle{min-width:44px;padding:5px 6px;}}
</style>
</head>
<body>

<div class="topbar">
  <div class="app-title">SEAN'S DAILY OPS</div>
  <div class="today-badge" id="real-date">...</div>
</div>

<div class="day-selector-wrap">
  <div class="day-selector-label">Next 7 Days</div>
  <div class="day-pills" id="day-pills"></div>
</div>

<div class="shift-banner">
  <div class="shift-banner-left">
    <div class="shift-banner-label" id="banner-label">Shift</div>
    <div class="shift-banner-time" id="shift-display"><span class="no-shift-set">Tap to set shift</span></div>
    <div id="event-display"></div>
  </div>
  <button class="edit-shift-btn" onclick="openShiftModal()">âš™ Set Shift</button>
</div>

<div class="progress-wrap">
  <div class="progress-header">
    <div class="progress-label">Progress</div>
    <div class="progress-count" id="progress-count">â€” / â€”</div>
  </div>
  <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
</div>

<div class="water-card">
  <div class="water-header">
    <div class="water-title">ğŸ’§ Water Tracker</div>
    <div class="water-right">
      <div>
        <div class="water-count-label" id="water-count">0 / 4</div>
        <div class="water-oz" id="water-oz">0 / 67.6 oz</div>
      </div>
    </div>
  </div>
  <div class="water-progress-wrap">
    <div class="water-progress-track"><div class="water-progress-fill" id="water-progress-fill"></div></div>
  </div>
  <div class="water-bottles" id="water-bottles"></div>
  <div class="water-note">Goal: <span>4 bottles (67.6 oz)</span> daily â€” cut the sugary drinks</div>
</div>

<div class="content">
  <div class="task-list" id="task-list"></div>
  <div class="sidebar">
    <div class="sidebar-card">
      <h3>ğŸ”¥ Streak</h3>
      <div class="streak-display"><div class="streak-num" id="streak-num">0</div><div class="streak-unit">days</div></div>
      <div class="streak-sub" id="streak-sub">Complete tasks to start your streak.</div>
      <div class="week-dots" id="week-dots"></div>
    </div>
    <div class="sidebar-card">
      <h3>ğŸ“Š 7-Day View</h3>
      <div class="heatmap" id="heatmap"></div>
    </div>
    <div class="sidebar-card">
      <h3>ğŸ“‹ History</h3>
      <div class="log-list" id="log-list"></div>
      <button class="reset-btn" onclick="confirmReset()">â†º Reset All Data</button>
    </div>
  </div>
</div>

<!-- SHIFT MODAL -->
<div class="modal-overlay" id="shift-modal">
  <div class="modal">
    <h2>Set Your Shift</h2>
    <p class="modal-sub">Set your work hours for this day. Bible study anchors first. Everything else optimizes around your shift.</p>

    <div class="modal-field">
      <label>Day</label>
      <div style="background:var(--surface2);border:1px solid var(--border2);border-radius:8px;padding:10px 14px;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:0.05em;color:var(--accent);" id="modal-day-display">â€”</div>
    </div>

    <div class="modal-field">
      <label>Day Off?</label>
      <div class="day-off-row">
        <input type="checkbox" id="day-off-check" style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer" onchange="toggleDayOffUI()">
        <span style="font-size:13px;color:var(--muted2)">No work â€” give me the full day schedule</span>
      </div>
    </div>

    <div id="shift-time-fields">
      <div class="modal-field">
        <label>Work Start</label>
        <select class="time-select" id="shift-start"></select>
      </div>
      <div class="modal-field">
        <label>Work End</label>
        <select class="time-select" id="shift-end"></select>
      </div>
      <div class="modal-field">
        <label>Workout Type Today</label>
        <div class="workout-toggle">
          <div class="workout-opt selected" id="wtype-gym" onclick="selectWorkoutType('gym')">ğŸ’ª Gym (Weights)</div>
          <div class="workout-opt" id="wtype-cardio" onclick="selectWorkoutType('cardio')">ğŸƒ Cardio</div>
          <div class="workout-opt" id="wtype-rest" onclick="selectWorkoutType('rest')">ğŸŒ¿ Rest Day</div>
        </div>
      </div>
    </div>

    <hr class="divider">
    <div class="event-section-title">Special Events</div>
    <div class="events-list" id="events-list"></div>

    <div id="add-event-form" style="display:none;background:var(--surface2);border:1px solid rgba(192,132,252,0.2);border-radius:9px;padding:12px;margin-bottom:10px;">
      <div class="modal-field" style="margin-bottom:10px;">
        <label>Event Name</label>
        <input type="text" class="text-input" id="event-name" placeholder="e.g. Doctor's appt, Birthday dinnerâ€¦">
      </div>
      <div class="modal-field" style="margin-bottom:10px;">
        <label>Start â†’ End Time</label>
        <div class="event-time-row">
          <select class="time-select" id="event-start" style="font-size:13px;padding:8px 10px;"></select>
          <select class="time-select" id="event-end" style="font-size:13px;padding:8px 10px;"></select>
        </div>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="addEvent()" style="flex:1;padding:8px;background:var(--purple);border:none;border-radius:7px;color:#fff;font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;cursor:pointer;">Add Event</button>
        <button onclick="document.getElementById('add-event-form').style.display='none'" style="padding:8px 14px;background:transparent;border:1px solid var(--border2);border-radius:7px;color:var(--muted);font-family:'Outfit',sans-serif;font-size:12px;cursor:pointer;">Cancel</button>
      </div>
    </div>

    <button class="add-event-btn" onclick="toggleEventForm()">+ Add Special Event</button>

    <button class="modal-btn" onclick="saveShift()">Build My Schedule</button>
    <span class="modal-cancel" onclick="closeShiftModal()">Cancel</span>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONSTANTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BOTTLE_OZ = 16.9;
const BOTTLE_GOAL = 4;
const SK = 'seans_daily_ops_v8';

const TAG = {
  bible:  {color:'#fbbf24', bg:'rgba(251,191,36,0.12)',  label:'Faith'},
  work:   {color:'#60a5fa', bg:'rgba(96,165,250,0.12)',  label:'Work'},
  gym:    {color:'#4ade80', bg:'rgba(74,222,128,0.12)',  label:'Gym'},
  cardio: {color:'#2dd4bf', bg:'rgba(45,212,191,0.12)',  label:'Cardio'},
  linalg: {color:'#c084fc', bg:'rgba(192,132,252,0.12)', label:'Study'},
  jobs:   {color:'#fb923c', bg:'rgba(251,146,60,0.12)',  label:'Career'},
  leet:   {color:'#f472b6', bg:'rgba(244,114,182,0.12)', label:'LeetCode'},
  food:   {color:'#a3a3a3', bg:'rgba(163,163,163,0.08)', label:'Nutrition'},
  travel: {color:'#6b7280', bg:'rgba(107,114,128,0.08)', label:'Travel'},
  free:   {color:'#555',    bg:'rgba(80,80,80,0.08)',    label:'Rest'},
  event:  {color:'#c084fc', bg:'rgba(192,132,252,0.12)', label:'Event'},
  prep:   {color:'#94a3b8', bg:'rgba(148,163,184,0.08)', label:'Routine'},
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TIME UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtTime(mins) {
  const h = Math.floor(mins / 60) % 24, m = mins % 60;
  const ap = h >= 12 ? 'PM' : 'AM', h12 = h % 12 || 12;
  return `${h12}:${m.toString().padStart(2,'0')} ${ap}`;
}
function fmtDur(mins) {
  const h = Math.floor(mins / 60), m = mins % 60;
  if (h === 0) return `${m} min`;
  if (m === 0) return `${h} hr${h > 1 ? 's' : ''}`;
  return `${h} hr ${m} min`;
}
function parseTime(str) {
  if (!str) return 0;
  const [time, ap] = str.split(' ');
  let [h, m] = time.split(':').map(Number);
  if (ap === 'PM' && h !== 12) h += 12;
  if (ap === 'AM' && h === 12) h = 0;
  return h * 60 + m;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATE UTILS
// Rolling 7 days: today through today+6
// All shifts/sessions keyed by "YYYY-MM-DD"
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayStr() {
  return localDateStr(new Date());
}
function localDateStr(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function get7Days() {
  const days = [];
  const base = new Date();
  base.setHours(0,0,0,0);
  for (let i = 0; i < 7; i++) {
    const d = new Date(base);
    d.setDate(base.getDate() + i);
    days.push({
      dateStr: localDateStr(d),
      dayName: d.toLocaleDateString('en-US', {weekday:'short'}),
      dateLabel: d.toLocaleDateString('en-US', {month:'short', day:'numeric'}),
      isToday: i === 0,
      jsDate: d
    });
  }
  return days;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// state.shifts  = { "YYYY-MM-DD": {start, end, dayOff, workoutType, events:[]} }
// state.history = { "YYYY-MM-DD": {done:[], total:0, water:0} }
let state = { activeDate: todayStr(), shifts: {}, history: {} };

function loadState() {
  try {
    const s = JSON.parse(localStorage.getItem(SK));
    if (s) {
      state.shifts  = s.shifts  || {};
      state.history = s.history || {};
    }
  } catch(e) {}
}
function saveState() {
  try { localStorage.setItem(SK, JSON.stringify({shifts:state.shifts, history:state.history})); }
  catch(e) {}
}
function getShift(dateStr)  { return state.shifts[dateStr]  || null; }
function getSess(dateStr)   { return state.history[dateStr] || null; }
function ensureSess(dateStr) {
  const shift = getShift(dateStr);
  const tasks = shift ? buildSchedule(shift) : [];
  if (!state.history[dateStr]) state.history[dateStr] = {done:[], total:tasks.length, water:0};
  state.history[dateStr].total = tasks.length;
  return state.history[dateStr];
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SCHEDULE BUILDER
//
// Wake time rules:
//   - Day off           â†’ 8:00 AM
//   - Morning shift     â†’ 6:30 AM (fixed early start regardless of shift)
//   - Afternoon/Evening â†’ 8:00 AM (plenty of morning time)
//
// Bible Study is ALWAYS slot 1 at wake time. Non-negotiable.
// Work block is pinned to exact shift times.
// Events are pinned to their times â€” everything else flows around them.
//
// Cursor tracks the "next available minute" and advances after every placed task.
// Fixed blocks (work/travel) jump cursor to their end time so downstream tasks chain correctly.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSchedule(shift) {
  const { start, end, dayOff, workoutType = 'gym', events = [] } = shift;
  const startMin = dayOff ? null : parseTime(start);
  const endMin   = dayOff ? null : parseTime(end);

  // Wake time â€” sleep at midnight = 8hrs rest
  // Day off gets full sleep-in: 9am
  let wakeTime;
  if (dayOff)                wakeTime = 9 * 60;        // 9:00 AM â€” full rest day
  else if (startMin < 12*60) wakeTime = 6 * 60 + 30;  // 6:30 AM for morning shifts
  else                       wakeTime = 8 * 60;        // 8:00 AM for afternoon/evening

  const tasks = [];
  let cursor = wakeTime;

  // place() puts a task at cursor and advances cursor by dur + 5 min buffer
  function place(dur, label, note, tag, isAnchor = false) {
    tasks.push({ time: cursor, dur, label, note, tag, isAnchor, isEvent: false });
    cursor += dur + 5;
  }

  // pin() puts a task at an EXACT time and advances cursor to that block's end + 5
  // Used for work, travel â€” these never move regardless of cursor position
  function pin(time, dur, label, note, tag, isAnchor = false) {
    tasks.push({ time, dur, label, note, tag, isAnchor, isEvent: false });
    cursor = time + dur + 5;
  }

  // â”€â”€ BIBLE STUDY â€” always first, always at wake â”€â”€
  place(25, 'ğŸ“– Bible Study', 'Anchor the day before anything else â€” Word first, always.', 'bible', true);

  // â”€â”€ Morning block helpers â”€â”€
  // Full morning block: Pre-gym Snack â†’ Gym/Cardio â†’ Morning Routine â†’ Breakfast
  // Rest day morning block: Morning Routine â†’ Breakfast
  function placeMorningBlock() {
    if (workoutType === 'rest') {
      place(20, 'ğŸš¿ Morning Routine', 'Shower, get dressed, ready to go', 'prep');
      place(30, 'ğŸ³ Breakfast',       'High protein + complex carbs â€” eat for fuel', 'food');
    } else {
      place(15, 'ğŸ¥¤ Pre-Gym Snack',   'Light snack â€” banana, protein bar, something quick', 'food');
      if (workoutType === 'cardio') place(50, 'ğŸƒ Cardio', 'Run or bike â€” your pace, push the zone', 'cardio');
      else                          place(75, 'ğŸ’ª Gym',    "10 min drive + 1 hr lift â€” don't skip",  'gym');
      place(20, 'ğŸš¿ Morning Routine', 'Shower + get ready post-workout',             'prep');
      place(30, 'ğŸ³ Breakfast',       'High protein post-workout meal â€” eat for gains', 'food');
    }
  }

  // Gym-only block for after work (no snack, since dinner comes first)
  function placePostWorkGym() {
    if (workoutType === 'rest') return;
    if (workoutType === 'cardio') place(50, 'ğŸƒ Cardio', 'Post-work cardio â€” burn it out', 'cardio');
    else                          place(75, 'ğŸ’ª Gym',    "Post-work lift â€” don't skip",    'gym');
    place(20, 'ğŸš¿ Post-Gym Shower', 'Clean up after the gym', 'prep');
  }

  // â”€â”€ Helper: pin work block, splitting around a mid-shift lunch â”€â”€
  // Always splits work into two halves with lunch at exact midpoint
  function pinWorkWithLunch(startM, endM) {
    const travelTo   = startM - 20;
    const lunchAt    = Math.floor(Math.floor((startM + endM) / 2) / 30) * 30;
    const work1Dur   = lunchAt - startM;
    const work2Start = lunchAt + 30;
    const work2Dur   = endM - work2Start;

    pin(travelTo,   20,        'ğŸš— Travel to Work', '20 min drive',                                  'travel');
    pin(startM,     work1Dur,  'ğŸ’¼ Work',            `${fmtTime(startM)} â€“ ${fmtTime(lunchAt)}`,      'work', true);
    pin(lunchAt,    30,        'ğŸ¥— Lunch Break',     'Mid-shift break â€” step away and eat',            'food');
    pin(work2Start, work2Dur,  'ğŸ’¼ Work',            `${fmtTime(work2Start)} â€“ ${fmtTime(endM)}`,      'work', true);
    pin(endM,       20,        'ğŸš— Travel Home',     '20 min drive',                                  'travel');
  }

  // â”€â”€ Helper: pin work block with pre-work lunch (shift starts 1 PM or later) â”€â”€
  function pinWorkPreLunch(startM, endM) {
    const travelTo = startM - 20;
    // Lunch at noon or whenever cursor lands, but must end at least 30 min before travel
    const lunchAt  = Math.min(Math.max(cursor, 12 * 60), travelTo - 60);
    pin(lunchAt,  30,          'ğŸ¥— Lunch',           'Fuel up before the shift â€” big meal',            'food');
    pin(travelTo, 20,          'ğŸš— Travel to Work',  '20 min drive',                                  'travel');
    pin(startM,   endM-startM, 'ğŸ’¼ Work',            `${fmtTime(startM)} â€“ ${fmtTime(endM)}`,          'work', true);
    pin(endM,     20,          'ğŸš— Travel Home',     '20 min drive',                                  'travel');
  }

  if (dayOff) {
    // â”€â”€ DAY OFF â”€â”€
    placeMorningBlock();
    place(30, 'ğŸ’» LeetCode',         '1 problem â€” daily non-negotiable',        'leet');
    place(75, 'ğŸ“š Linear Algebra',   'Deep work block â€” no distractions',       'linalg');
    place(45, 'ğŸ’¼ Job Applications', 'Quality over quantity â€” track everything', 'jobs');
    place(30, 'ğŸ¥— Lunch',            'Fuel up mid-day',                          'food');
    place(90, 'ğŸŒ¿ Free Time',        'Rest, friends, recharge â€” no guilt',       'free');
    place(30, 'ğŸ½ï¸ Dinner',          'High protein evening meal',                'food');
    place(20, "ğŸ—“ï¸ Plan Tomorrow",   "Set tomorrow's shift & review goals",      'prep');

  } else if (startMin < 12 * 60) {
    // â”€â”€ MORNING SHIFT (starts before noon) â”€â”€
    // Gym fits pre-work only if there's a 2hr window between wake and travel
    const travelStart   = startMin - 20;
    const gymFitsPreWork = (travelStart - cursor) >= 120;

    if (gymFitsPreWork) {
      placeMorningBlock();
    } else {
      place(20, 'ğŸš¿ Morning Routine', 'Quick shower, get ready for work', 'prep');
      place(30, 'ğŸ³ Breakfast',       'Quick high-protein breakfast',     'food');
    }

    // Lunch always mid-shift for morning shifts
    pinWorkWithLunch(startMin, endMin);

    place(30, 'ğŸ½ï¸ Dinner', 'Big post-work meal â€” fuel the evening', 'food');

    if (!gymFitsPreWork) {
      placePostWorkGym();
    }

    place(30, 'ğŸ’» LeetCode',         '1 problem â€” daily non-negotiable',       'leet');
    place(60, 'ğŸ“š Linear Algebra',   'Study session â€” stay consistent',         'linalg');
    place(45, 'ğŸ’¼ Job Applications', '45 min focused â€” quality over quantity',  'jobs');
    place(20, 'ğŸŒ™ Wind Down',        'Protein snack, water, decompress',        'prep');

  } else {
    // â”€â”€ AFTERNOON / EVENING SHIFT (starts at noon or later) â”€â”€
    placeMorningBlock();
    place(30, 'ğŸ’» LeetCode',         '1 problem â€” daily non-negotiable',       'leet');
    place(60, 'ğŸ“š Linear Algebra',   'Study while your brain is fresh',         'linalg');
    place(45, 'ğŸ’¼ Job Applications', 'Morning grind â€” quality applications',    'jobs');

    if (startMin >= 13 * 60) {
      // 1 PM or later â€” lunch before work
      pinWorkPreLunch(startMin, endMin);
    } else {
      // Noon shift â€” lunch mid-shift
      pinWorkWithLunch(startMin, endMin);
    }

    place(30, 'ğŸ½ï¸ Dinner',    'Protein + healthy fats',             'food');
    place(20, 'ğŸŒ™ Wind Down', 'Plan tomorrow, hydrate, decompress', 'prep');
  }

  // â”€â”€ INJECT SPECIAL EVENTS & RESOLVE COLLISIONS â”€â”€
  if (events.length > 0) {
    return resolveWithEvents(tasks, events);
  }

  tasks.sort((a, b) => a.time - b.time);
  return tasks.map(t => ({...t, timeStr: fmtTime(t.time), durStr: fmtDur(t.dur)}));
}

function resolveWithEvents(baseTasks, events) {
  // Parse event blocks â€” completely immovable
  const eventBlocks = events.map(ev => {
    const st  = parseTime(ev.start);
    const en  = parseTime(ev.end);
    const dur = en > st ? en - st : 60;
    return { time: st, dur, end: st + dur,
      label: `ğŸ—“ï¸ ${ev.name}`, note: `${ev.start} â€“ ${ev.end}`,
      tag: 'event', isEvent: true, isAnchor: false }; // isAnchor:false so Bible Study isn't displaced
  }).sort((a, b) => a.time - b.time);

  // Things that must never be moved: work block, travel, bible study
  const IMMOVABLE = (t) => t.tag === 'work' || t.tag === 'travel' || t.tag === 'bible';

  // Push each movable task past any event it overlaps
  let resolved = baseTasks.map(task => {
    if (IMMOVABLE(task)) return task;
    let t = {...task};
    for (let iter = 0; iter < 30; iter++) {
      const tEnd = t.time + t.dur;
      const clash = eventBlocks.find(ev => t.time < ev.end && tEnd > ev.time);
      if (!clash) break;
      t = {...t, time: clash.end + 10};
    }
    return t;
  });

  // Sort and cascade: if any task overlaps the previous, push it forward
  // Preserve immovable tasks in place
  resolved.sort((a, b) => a.time - b.time);

  for (let i = 1; i < resolved.length; i++) {
    const prev = resolved[i - 1];
    const curr = resolved[i];
    if (IMMOVABLE(curr)) continue;
    const prevEnd = prev.time + prev.dur;
    if (curr.time < prevEnd) {
      resolved[i] = {...curr, time: prevEnd + 5};
    }
  }

  // Merge events into the list
  const all = [...resolved, ...eventBlocks];
  all.sort((a, b) => a.time - b.time);
  return all.map(t => ({...t, timeStr: fmtTime(t.time), durStr: fmtDur(t.dur)}));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MODAL STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let modalDate = null;
let pendingEvents = [];
let pendingWorkoutType = 'gym';

function generateTimeOptions() {
  const t = [];
  for (let h = 4; h <= 23; h++) for (let m of [0, 30]) {
    const ap = h >= 12 ? 'PM' : 'AM', h12 = h % 12 || 12;
    t.push(`${h12}:${m.toString().padStart(2,'0')} ${ap}`);
  }
  return t;
}
function populateTimeSelect(id, defaultVal) {
  const el = document.getElementById(id);
  const times = generateTimeOptions();
  el.innerHTML = times.map(t => `<option value="${t}">${t}</option>`).join('');
  if (defaultVal) el.value = defaultVal;
}

function openShiftModal() {
  modalDate = state.activeDate;

  // Show which day in modal
  const dayInfo = get7Days().find(d => d.dateStr === modalDate);
  const label = dayInfo ? `${dayInfo.dayName}, ${dayInfo.dateLabel}` : modalDate;
  document.getElementById('modal-day-display').textContent = label;

  populateTimeSelect('shift-start', '9:00 AM');
  populateTimeSelect('shift-end',   '5:00 PM');
  populateTimeSelect('event-start', '9:00 AM');
  populateTimeSelect('event-end',   '10:00 AM');

  // Load existing shift if any
  const ex = getShift(modalDate);
  if (ex) {
    document.getElementById('shift-start').value = ex.start || '9:00 AM';
    document.getElementById('shift-end').value   = ex.end   || '5:00 PM';
    document.getElementById('day-off-check').checked = ex.dayOff || false;
    pendingEvents = [...(ex.events || [])];
    pendingWorkoutType = ex.workoutType || 'gym';
  } else {
    document.getElementById('shift-start').value = '9:00 AM';
    document.getElementById('shift-end').value   = '5:00 PM';
    document.getElementById('day-off-check').checked = false;
    pendingEvents = [];
    pendingWorkoutType = 'gym';
  }

  toggleDayOffUI();
  selectWorkoutType(pendingWorkoutType);
  renderModalEvents();
  document.getElementById('add-event-form').style.display = 'none';
  document.getElementById('event-name').value = '';
  document.getElementById('shift-modal').classList.add('show');
}

function toggleDayOffUI() {
  const off = document.getElementById('day-off-check').checked;
  document.getElementById('shift-time-fields').style.display = off ? 'none' : 'block';
}

function selectWorkoutType(type) {
  pendingWorkoutType = type;
  ['gym','cardio','rest'].forEach(t => {
    document.getElementById(`wtype-${t}`).classList.toggle('selected', t === type);
  });
}

function toggleEventForm() {
  const form = document.getElementById('add-event-form');
  const hidden = form.style.display === 'none' || form.style.display === '';
  form.style.display = hidden ? 'block' : 'none';
  if (hidden) document.getElementById('event-name').focus();
}

function addEvent() {
  const name = document.getElementById('event-name').value.trim();
  if (!name) { showToast('âš ï¸ Enter an event name'); return; }
  const start = document.getElementById('event-start').value;
  const end   = document.getElementById('event-end').value;
  if (parseTime(start) >= parseTime(end)) { showToast('âš ï¸ End time must be after start'); return; }
  pendingEvents.push({ name, start, end });
  document.getElementById('event-name').value = '';
  document.getElementById('add-event-form').style.display = 'none';
  renderModalEvents();
  showToast(`âœ“ "${name}" added`);
}

function removeEvent(i) {
  pendingEvents.splice(i, 1);
  renderModalEvents();
}

function renderModalEvents() {
  const el = document.getElementById('events-list');
  if (!pendingEvents.length) {
    el.innerHTML = `<div style="font-size:11px;color:var(--muted);font-family:'Courier Prime',monospace;text-align:center;padding:8px;">No special events added</div>`;
    return;
  }
  el.innerHTML = pendingEvents.map((ev, i) => `
    <div class="event-item">
      <div>
        <div class="event-item-text">${ev.name}</div>
        <div class="event-item-time">${ev.start} â€“ ${ev.end}</div>
      </div>
      <button class="event-delete" onclick="removeEvent(${i})">âœ•</button>
    </div>
  `).join('');
}

function closeShiftModal() { document.getElementById('shift-modal').classList.remove('show'); }

function saveShift() {
  const dayOff = document.getElementById('day-off-check').checked;
  const start  = document.getElementById('shift-start').value;
  const end    = document.getElementById('shift-end').value;

  if (!dayOff && parseTime(start) >= parseTime(end)) {
    showToast('âš ï¸ End time must be after start'); return;
  }

  state.shifts[modalDate] = {
    start, end, dayOff,
    workoutType: pendingWorkoutType,
    events: [...pendingEvents]
  };

  // Clear session so it rebuilds fresh
  delete state.history[modalDate];

  saveState();
  closeShiftModal();
  renderAll();

  const wt = pendingWorkoutType === 'gym' ? 'ğŸ’ª' : pendingWorkoutType === 'cardio' ? 'ğŸƒ' : 'ğŸŒ¿';
  const evText = pendingEvents.length ? ` + ${pendingEvents.length} event${pendingEvents.length > 1 ? 's' : ''}` : '';
  showToast(dayOff ? `Day off scheduled ğŸŒ¿` : `${start} â€“ ${end} Â· ${wt}${evText} âœ“`);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() { renderPills(); renderBanner(); renderTasks(); renderWater(); renderSidebar(); }

function renderPills() {
  const days = get7Days();
  const todayDate = todayStr();
  document.getElementById('day-pills').innerHTML = days.map(d => {
    const sess  = getSess(d.dateStr);
    const shift = getShift(d.dateStr);
    const isActive = d.dateStr === state.activeDate;
    const pct = sess && sess.total > 0 ? Math.round(sess.done.length / sess.total * 100) : 0;
    const hasHistory = sess && sess.done.length > 0;

    let sub = 'â€”';
    if (sess && sess.done.length > 0) sub = pct + '%';
    else if (shift) sub = shift.dayOff ? 'Off' : shift.start.replace(':00','').replace(' ','').toLowerCase();

    return `<div class="day-pill ${isActive ? 'active' : ''} ${hasHistory ? 'has-history' : ''} ${d.isToday ? 'today-pill' : ''}"
      onclick="selectDay('${d.dateStr}')">
      <div class="pill-done-dot"></div>
      <div class="pill-name">${d.dayName}</div>
      <div class="pill-date">${d.dateLabel}</div>
      <div class="pill-sub">${sub}</div>
    </div>`;
  }).join('');
}

function renderBanner() {
  const shift  = getShift(state.activeDate);
  const el     = document.getElementById('shift-display');
  const evEl   = document.getElementById('event-display');
  const btn    = document.querySelector('.edit-shift-btn');
  const lbl    = document.getElementById('banner-label');
  const dayInfo = get7Days().find(d => d.dateStr === state.activeDate);
  lbl.textContent = dayInfo ? `${dayInfo.dayName} Shift` : 'Shift';

  if (!shift) {
    el.innerHTML = `<span class="no-shift-set">Tap to set shift</span>`;
    btn.textContent = 'âš™ Set Shift';
    evEl.innerHTML = '';
  } else if (shift.dayOff) {
    el.innerHTML = `<span style="color:var(--green)">Day Off ğŸŒ¿</span>`;
    btn.textContent = 'âœ Edit';
    evEl.innerHTML = '';
  } else {
    el.innerHTML = `<span>${shift.start}</span> â†’ <span>${shift.end}</span>`;
    btn.textContent = 'âœ Edit';
    const evBadges = (shift.events || []).map(ev =>
      `<span class="event-badge">ğŸ—“ï¸ ${ev.name} Â· ${ev.start}</span>`
    ).join('');
    const wtLabel = shift.workoutType === 'cardio' ? 'ğŸƒ Cardio' : shift.workoutType === 'rest' ? 'ğŸŒ¿ Rest' : 'ğŸ’ª Gym';
    evEl.innerHTML = `<span class="event-badge" style="background:var(--green-dim);border-color:rgba(74,222,128,0.3);color:var(--green)">${wtLabel}</span>${evBadges}`;
  }
}

function renderTasks() {
  const dateStr = state.activeDate;
  const shift   = getShift(dateStr);
  const container = document.getElementById('task-list');

  if (!shift) {
    container.innerHTML = `<div class="empty-state"><div class="big">âš™ï¸</div>No shift set.<br><strong style="color:var(--accent)">Tap "Set Shift"</strong> to build your schedule.<br><br><span style="color:var(--muted2);font-size:11px">Tip: set tomorrow's shift the night before.</span></div>`;
    document.getElementById('progress-count').textContent = 'â€” / â€”';
    document.getElementById('progress-fill').style.width = '0%';
    return;
  }

  const tasks = buildSchedule(shift);
  const sess  = ensureSess(dateStr);

  container.innerHTML = tasks.map((t, i) => {
    const done = sess.done.includes(i);
    const tag  = TAG[t.tag] || TAG.free;
    const anchorBadge = t.isAnchor && t.tag !== 'work' ? `<span class="anchor-badge">Anchor</span>` : '';
    return `<div class="task-card ${done ? 'done' : ''} ${t.isEvent ? 'event-task' : ''} ${t.isAnchor && !t.isEvent ? 'anchor-task' : ''}"
      style="--card-color:${tag.color}" onclick="toggleTask(${i})">
      <div class="task-check">${done ? 'âœ“' : ''}</div>
      <div class="task-body">
        <div class="task-top">
          <div class="task-time">${t.timeStr}</div>
          <div class="task-duration">${t.durStr}</div>
        </div>
        <div class="task-label">${t.label}${anchorBadge}</div>
        <div class="task-note">${t.note}</div>
        <span class="task-tag" style="color:${tag.color};background:${tag.bg}">${tag.label}</span>
      </div>
    </div>`;
  }).join('');

  renderProgress(sess, tasks.length);
}

function renderProgress(sess, total) {
  const done = sess ? sess.done.length : 0;
  const pct  = total > 0 ? Math.round(done / total * 100) : 0;
  document.getElementById('progress-count').textContent = `${done} / ${total}`;
  document.getElementById('progress-fill').style.width  = pct + '%';
}

function renderWater() {
  const sess    = getSess(state.activeDate) || {water: 0};
  const bottles = sess.water || 0;
  const ozDone  = (bottles * BOTTLE_OZ).toFixed(1);
  const ozTotal = (BOTTLE_GOAL * BOTTLE_OZ).toFixed(1);
  const pct = Math.round(bottles / BOTTLE_GOAL * 100);

  document.getElementById('water-count').textContent = `${bottles} / ${BOTTLE_GOAL}`;
  document.getElementById('water-oz').textContent    = `${ozDone} / ${ozTotal} oz`;
  document.getElementById('water-progress-fill').style.width = pct + '%';

  document.getElementById('water-bottles').innerHTML = Array.from({length: BOTTLE_GOAL}, (_, i) => `
    <div class="bottle ${i < bottles ? 'filled' : ''}" onclick="tapWater(${i})">
      <div class="bottle-icon">ğŸ’§</div>
      <div class="bottle-label">${BOTTLE_OZ} oz</div>
    </div>
  `).join('');
}

function renderSidebar() {
  const days = get7Days();
  const todayDate = todayStr();

  // Streak â€” consecutive days with completed tasks
  const allDates = Object.entries(state.history)
    .filter(([k, v]) => v.done.length > 0)
    .map(([k]) => k)
    .sort();

  let streak = 0;
  const d = new Date();
  for (let i = 0; i < 365; i++) {
    const ds = localDateStr(d);
    if (allDates.includes(ds)) { streak++; d.setDate(d.getDate() - 1); }
    else if (i === 0) { d.setDate(d.getDate() - 1); } // skip today if not done yet
    else break;
  }
  document.getElementById('streak-num').textContent = streak;
  document.getElementById('streak-sub').textContent =
    streak === 0 ? 'Complete tasks to start your streak.' :
    streak === 1 ? 'Day 1. Every legend starts here.' :
    streak < 7   ? `${streak} days strong. Build the habit.` :
    `${streak} days. This is who you are now.`;

  // 7-day dots
  document.getElementById('week-dots').innerHTML = days.map(d => {
    const s = getSess(d.dateStr);
    const pct = s && s.total > 0 ? s.done.length / s.total : 0;
    const isToday = d.dateStr === todayDate;
    const cls = pct === 0 ? '' : pct >= 1 ? 'full' : 'partial';
    return `<div class="w-dot ${cls} ${isToday ? 'today-dot' : ''}">${d.dayName.charAt(0)}</div>`;
  }).join('');

  // Heatmap
  document.getElementById('heatmap').innerHTML = days.map(d => {
    const s   = getSess(d.dateStr);
    const pct = s && s.total > 0 ? s.done.length / s.total : 0;
    const color = pct === 0 ? '#222' : pct < 0.5 ? '#fb923c' : pct < 1 ? '#e8ff47' : '#4ade80';
    return `<div class="heatmap-row">
      <div class="heatmap-day-label">${d.dayName}</div>
      <div class="heatmap-bar-wrap"><div class="heatmap-bar" style="width:${Math.round(pct*100)}%;background:${color}"></div></div>
      <div class="heatmap-pct">${s && s.total > 0 ? Math.round(pct*100)+'%' : 'â€”'}</div>
    </div>`;
  }).join('');

  // Log
  const entries = Object.entries(state.history)
    .filter(([k, v]) => v.done.length > 0)
    .sort(([a], [b]) => b.localeCompare(a))
    .slice(0, 20);

  const logEl = document.getElementById('log-list');
  if (!entries.length) {
    logEl.innerHTML = `<div class="empty-state"><div class="big">ğŸ“‹</div>No history yet.<br>Start checking off tasks.</div>`;
    return;
  }
  logEl.innerHTML = entries.map(([date, val]) => {
    const pct  = val.total > 0 ? Math.round(val.done.length / val.total * 100) : 0;
    const pc   = pct >= 100 ? 'great' : pct >= 50 ? 'good' : '';
    const dc   = pct >= 100 ? '#4ade80' : pct >= 50 ? '#e8ff47' : '#fb923c';
    const ds   = new Date(date + 'T12:00:00').toLocaleDateString('en-US', {month:'short', day:'numeric', weekday:'short'});
    const sh   = state.shifts[date];
    const sl   = sh ? (sh.dayOff ? 'Off' : `${sh.start}â€“${sh.end}`) : '';
    return `<div class="log-item">
      <div class="log-item-left">
        <div class="log-dot" style="background:${dc}"></div>
        <div><div class="log-text">${ds}</div><div class="log-meta">${sl}</div></div>
      </div>
      <div class="log-pct ${pc}">${pct}%</div>
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectDay(dateStr) {
  state.activeDate = dateStr;
  renderAll();
}

function toggleTask(i) {
  const sess  = ensureSess(state.activeDate);
  const shift = getShift(state.activeDate);
  if (sess.done.includes(i)) {
    sess.done = sess.done.filter(x => x !== i);
  } else {
    sess.done.push(i);
    const tasks = shift ? buildSchedule(shift) : [];
    if (sess.done.length === tasks.length && tasks.length > 0) {
      showToast('ğŸ”¥ Day complete! Full send.');
    }
  }
  saveState();
  renderTasks();
  renderPills();
  renderSidebar();
}

function tapWater(i) {
  const sess = ensureSess(state.activeDate);
  const cur  = sess.water || 0;
  sess.water = cur === i + 1 ? i : i + 1;
  if (sess.water === BOTTLE_GOAL) showToast(`ğŸ’§ ${BOTTLE_GOAL} bottles done! Hydration goal hit!`);
  saveState();
  renderWater();
}

function confirmReset() {
  if (confirm('Reset all data? This cannot be undone.')) {
    state.history = {};
    state.shifts  = {};
    saveState();
    renderAll();
    showToast('ğŸ—‘ï¸ All data cleared.');
  }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Night reminder
function nightBeforeCheck() {
  const hour = new Date().getHours();
  if (hour >= 20) {
    const days = get7Days();
    const tomorrow = days[1];
    if (tomorrow && !getShift(tomorrow.dateStr)) {
      setTimeout(() => showToast(`ğŸ“… Set tomorrow's shift (${tomorrow.dayName}) tonight`), 1500);
    }
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  const now = new Date();
  document.getElementById('real-date').textContent =
    now.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
  loadState();
  renderAll();
  nightBeforeCheck();
  if ('serviceWorker' in navigator)
    window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js').catch(() => {}));
}

init();
</script>
</body>
</html>
